-- VERSION 5.0 - DELTA EXECUTOR MOBILE SPECIFIC APPROACH
-- Completely different storage and table access methods

local P = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local p = P.LocalPlayer

print("========================================")
print("REMOTE HOOK TEST - VERSION 5.0")
print("Delta Executor Mobile Specific")
print("========================================")

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Remote Hook Test v5.0",
    Text = "Delta Mobile specific!",
    Duration = 5
})

wait(1)

-- Webhook
local WEBHOOK = "https://discord.com/api/webhooks/1227328649322168391/2SdD38qqsMjyktorFtdOLO7p9yN_RK_VdVocfiuT-SxRVKX1t5dMEw3STYxfSWCz7IeQ"

-- Try to get metamethod bypass functions
local getrawmetatable = getrawmetatable or debug.getmetatable
local setreadonly = setreadonly or function() end
local newcclosure = newcclosure or function(f) return f end

-- HTTP library for Delta Mobile
local httpLib = nil
if delta and delta.request then
    httpLib = function(url, method, headers, body)
        local res = delta.request({Url = url, Method = method, Headers = headers, Body = body})
        return res.Success, res.Body, res.StatusCode
    end
elseif request then
    httpLib = function(url, method, headers, body)
        local res = request({Url = url, Method = method, Headers = headers, Body = body})
        return res.Success or res.success, res.Body or res.body, res.StatusCode
    end
end

-- Simple JSON encoder
local function jsonEncode(t)
    local parts = {}
    for k, v in pairs(t) do
        local key = string.format("%q", k)
        local val = type(v) == "string" and string.format("%q", v) or tostring(v)
        table.insert(parts, key .. ":" .. val)
    end
    return "{" .. table.concat(parts, ",") .. "}"
end

-- Create storage in a StringValue (alternative to _G)
local storage = Instance.new("StringValue")
storage.Name = "RH_Storage"
storage.Parent = RS
local eventCount = 0
local storedEvents = ""

-- Simple GUI
local g = Instance.new("ScreenGui")
g.Name = "RemoteHookV5"
g.Parent = p.PlayerGui

local f = Instance.new("Frame")
f.Size = UDim2.new(0, 360, 0, 320)
f.Position = UDim2.new(0.5, -180, 0.5, -160)
f.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
f.Parent = g

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 35)
title.BackgroundColor3 = Color3.fromRGB(50, 150, 50)
title.Text = "v5.0 - Delta Mobile"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 14
title.Font = Enum.Font.GothamBold
title.Parent = f

local log = Instance.new("TextLabel")
log.Size = UDim2.new(0, 340, 0, 180)
log.Position = UDim2.new(0, 10, 0, 45)
log.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
log.Text = "Ready..."
log.TextColor3 = Color3.fromRGB(200, 255, 200)
log.TextSize = 9
log.Font = Enum.Font.Gotham
log.TextWrapped = true
log.TextXAlignment = Enum.TextXAlignment.Left
log.TextYAlignment = Enum.TextYAlignment.Top
log.Parent = f

local status = Instance.new("TextLabel")
status.Size = UDim2.new(0, 340, 0, 18)
status.Position = UDim2.new(0, 10, 0, 230)
status.BackgroundTransparency = 1
status.Text = "Events: 0 | Stored: 0"
status.TextColor3 = Color3.fromRGB(255, 255, 100)
status.TextSize = 10
status.Font = Enum.Font.GothamBold
status.TextXAlignment = Enum.TextXAlignment.Left
status.Parent = f

local function addLog(txt)
    local lines = {}
    for line in string.gmatch(log.Text, "([^\n]+)") do
        table.insert(lines, line)
    end
    table.insert(lines, txt)
    while #lines > 12 do table.remove(lines, 1) end
    log.Text = table.concat(lines, "\n")
end

-- Buttons
local hookBtn = Instance.new("TextButton")
hookBtn.Size = UDim2.new(0, 105, 0, 26)
hookBtn.Position = UDim2.new(0, 10, 0, 253)
hookBtn.BackgroundColor3 = Color3.fromRGB(200, 100, 50)
hookBtn.Text = "Hook Remote"
hookBtn.TextSize = 10
hookBtn.Font = Enum.Font.Gotham
hookBtn.Parent = f

local testBtn = Instance.new("TextButton")
testBtn.Size = UDim2.new(0, 105, 0, 26)
testBtn.Position = UDim2.new(0, 125, 0, 253)
testBtn.BackgroundColor3 = Color3.fromRGB(200, 150, 50)
testBtn.Text = "Test Webhook"
testBtn.TextSize = 10
testBtn.Font = Enum.Font.Gotham
testBtn.Parent = f

local sendBtn = Instance.new("TextButton")
sendBtn.Size = UDim2.new(0, 105, 0, 26)
sendBtn.Position = UDim2.new(0, 245, 0, 253)
sendBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
sendBtn.Text = "Send Events"
sendBtn.TextSize = 10
sendBtn.Font = Enum.Font.Gotham
sendBtn.Parent = f

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 105, 0, 26)
closeBtn.Position = UDim2.new(0, 127, 0, 285)
closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeBtn.Text = "Close"
closeBtn.TextSize = 10
closeBtn.Font = Enum.Font.GothamBold
closeBtn.Parent = f

-- Function to extract data from tables bypassing metatables
local function extractTableData(tbl, depth)
    depth = depth or 0
    if depth > 3 then return "[deep]" end
    if type(tbl) ~= "table" then return tostring(tbl) end
    
    local result = {}
    
    -- Try getrawmetatable to bypass __index
    local success, mt = pcall(getrawmetatable, tbl)
    if success and mt then
        pcall(setreadonly, mt, false)
    end
    
    -- Try numeric indices first
    for i = 1, 20 do
        local val = rawget(tbl, i)
        if val ~= nil then
            if type(val) == "table" then
                result[i] = extractTableData(val, depth + 1)
            else
                result[i] = tostring(val)
            end
        else
            break
        end
    end
    
    -- Try string keys
    for k, v in pairs(tbl) do
        if type(k) == "string" then
            if type(v) == "table" then
                result[k] = extractTableData(v, depth + 1)
            else
                result[k] = tostring(v)
            end
        end
    end
    
    return result
end

-- Hook the remote
local remote = nil
local original = nil
local hooked = false

hookBtn.Activated:Connect(function()
    if hooked then
        addLog("Already hooked!")
        return
    end
    
    addLog("Finding remote...")
    local success, r = pcall(function()
        return RS.Shared.Framework.Network.Remote.RemoteEvent
    end)
    
    if not success or not r then
        addLog("‚ùå Remote not found!")
        return
    end
    
    remote = r
    addLog("‚úì Found: " .. remote.Name)
    
    -- Hook FireClient
    pcall(function()
        original = remote.FireClient
        
        remote.FireClient = newcclosure(function(self, ...)
            local args = {...}
            eventCount = eventCount + 1
            
            -- IMMEDIATE visual feedback
            status.Text = "Events: " .. eventCount .. " | JUST FIRED!"
            status.TextColor3 = Color3.fromRGB(255, 100, 100)
            
            -- Build event string
            local eventStr = "Event #" .. eventCount .. " @ " .. os.date("%X") .. "\n"
            
            for i, arg in ipairs(args) do
                if type(arg) == "string" then
                    eventStr = eventStr .. "Arg" .. i .. ": " .. arg .. "\n"
                elseif type(arg) == "number" then
                    eventStr = eventStr .. "Arg" .. i .. ": " .. tostring(arg) .. "\n"
                elseif type(arg) == "table" then
                    -- Extract table data
                    local extracted = extractTableData(arg)
                    
                    -- Check for Pets
                    if arg.Pets or extracted.Pets then
                        local pets = arg.Pets or extracted.Pets
                        if type(pets) == "table" then
                            for pi = 1, 10 do
                                local pet = pets[pi]
                                if pet and type(pet) == "table" then
                                    local petObj = pet.Pet
                                    if petObj and type(petObj) == "table" then
                                        local name = petObj.Name or rawget(petObj, "Name")
                                        if name then
                                            eventStr = eventStr .. "Pet" .. pi .. ": " .. tostring(name) .. "\n"
                                        end
                                    end
                                end
                            end
                        end
                    end
                    
                    -- Show egg name
                    if arg.Name then
                        eventStr = eventStr .. "Egg: " .. tostring(arg.Name) .. "\n"
                    end
                end
            end
            
            eventStr = eventStr .. "---\n"
            
            -- Store in StringValue
            storedEvents = storedEvents .. eventStr
            storage.Value = storedEvents
            
            -- Update UI
            addLog("Event #" .. eventCount)
            status.Text = "Events: " .. eventCount .. " | Stored: " .. #storedEvents .. " chars"
            status.TextColor3 = Color3.fromRGB(100, 255, 100)
            
            -- Call original
            return original(self, unpack(args))
        end)
        
        hooked = true
        addLog("‚úì HOOKED!")
        hookBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
        hookBtn.Text = "‚úì Hooked"
    end)
end)

-- Test webhook
testBtn.Activated:Connect(function()
    if not httpLib then
        addLog("‚ùå No HTTP library!")
        return
    end
    
    addLog("Sending test...")
    local payload = {content = "üß™ Test from v5.0 - " .. os.date("%X")}
    local json = jsonEncode(payload)
    local headers = {["Content-Type"] = "application/json"}
    
    local success, _, status = httpLib(WEBHOOK, "POST", headers, json)
    
    if success and (status == 200 or status == 204) then
        addLog("‚úì Test sent!")
    else
        addLog("‚ùå Test failed: " .. tostring(status))
    end
end)

-- Send stored events
sendBtn.Activated:Connect(function()
    if not httpLib then
        addLog("‚ùå No HTTP!")
        return
    end
    
    if storedEvents == "" or #storedEvents < 10 then
        addLog("‚ùå No events stored!")
        addLog("Event count: " .. eventCount)
        addLog("Storage length: " .. #storedEvents)
        return
    end
    
    addLog("Sending " .. eventCount .. " events...")
    
    local content = "**Events: " .. eventCount .. "**\n```\n" .. storedEvents .. "\n```"
    if #content > 1900 then
        content = string.sub(content, 1, 1900) .. "...\n```"
    end
    
    local payload = {content = content}
    local json = jsonEncode(payload)
    local headers = {["Content-Type"] = "application/json"}
    
    local success, _, st = httpLib(WEBHOOK, "POST", headers, json)
    
    if success and (st == 200 or st == 204) then
        addLog("‚úì Sent " .. eventCount .. " events!")
        storedEvents = ""
        storage.Value = ""
        eventCount = 0
        status.Text = "Events: 0 | Stored: 0"
    else
        addLog("‚ùå Send failed: " .. tostring(st))
    end
end)

-- Close
closeBtn.Activated:Connect(function()
    if original and remote then
        remote.FireClient = original
    end
    g:Destroy()
    if storage then storage:Destroy() end
end)

addLog("Ready! Click 'Hook Remote'")
addLog("Then hatch eggs to test")

