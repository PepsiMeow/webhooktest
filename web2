-- VERSION 6.0 - ONCLIENTEVENT APPROACH WITH PROPER STORAGE
-- Back to OnClientEvent but with fixed storage and table access

local P = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local p = P.LocalPlayer

print("========================================")
print("REMOTE HOOK TEST - VERSION 6.0")
print("OnClientEvent + Fixed Storage")
print("========================================")

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Remote Hook Test v6.0",
    Text = "OnClientEvent approach!",
    Duration = 5
})

wait(1)

-- Webhook
local WEBHOOK = "https://discord.com/api/webhooks/1227328649322168391/2SdD38qqsMjyktorFtdOLO7p9yN_RK_VdVocfiuT-SxRVKX1t5dMEw3STYxfSWCz7IeQ"

-- Try to get metamethod bypass functions
local getrawmetatable = getrawmetatable or debug.getmetatable
local setreadonly = setreadonly or function() end
local newcclosure = newcclosure or function(f) return f end

-- HTTP library for Delta Mobile
local httpLib = nil
if delta and delta.request then
    httpLib = function(url, method, headers, body)
        local res = delta.request({Url = url, Method = method, Headers = headers, Body = body})
        return res.Success, res.Body, res.StatusCode
    end
elseif request then
    httpLib = function(url, method, headers, body)
        local res = request({Url = url, Method = method, Headers = headers, Body = body})
        return res.Success or res.success, res.Body or res.body, res.StatusCode
    end
end

-- Simple JSON encoder
local function jsonEncode(t)
    local parts = {}
    for k, v in pairs(t) do
        local key = string.format("%q", k)
        local val = type(v) == "string" and string.format("%q", v) or tostring(v)
        table.insert(parts, key .. ":" .. val)
    end
    return "{" .. table.concat(parts, ",") .. "}"
end

-- Create storage in a StringValue (alternative to _G)
local storage = Instance.new("StringValue")
storage.Name = "RH_Storage"
storage.Parent = RS
local eventCount = 0
local storedEvents = ""

-- Simple GUI
local g = Instance.new("ScreenGui")
g.Name = "RemoteHookV5"
g.Parent = p.PlayerGui

local f = Instance.new("Frame")
f.Size = UDim2.new(0, 360, 0, 320)
f.Position = UDim2.new(0.5, -180, 0.5, -160)
f.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
f.Parent = g

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 35)
title.BackgroundColor3 = Color3.fromRGB(50, 150, 50)
title.Text = "v6.0 - OnClientEvent"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 14
title.Font = Enum.Font.GothamBold
title.Parent = f

local log = Instance.new("TextLabel")
log.Size = UDim2.new(0, 340, 0, 180)
log.Position = UDim2.new(0, 10, 0, 45)
log.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
log.Text = "Ready..."
log.TextColor3 = Color3.fromRGB(200, 255, 200)
log.TextSize = 9
log.Font = Enum.Font.Gotham
log.TextWrapped = true
log.TextXAlignment = Enum.TextXAlignment.Left
log.TextYAlignment = Enum.TextYAlignment.Top
log.Parent = f

local status = Instance.new("TextLabel")
status.Size = UDim2.new(0, 340, 0, 18)
status.Position = UDim2.new(0, 10, 0, 230)
status.BackgroundTransparency = 1
status.Text = "Events: 0 | Stored: 0"
status.TextColor3 = Color3.fromRGB(255, 255, 100)
status.TextSize = 10
status.Font = Enum.Font.GothamBold
status.TextXAlignment = Enum.TextXAlignment.Left
status.Parent = f

local function addLog(txt)
    local lines = {}
    for line in string.gmatch(log.Text, "([^\n]+)") do
        table.insert(lines, line)
    end
    table.insert(lines, txt)
    while #lines > 12 do table.remove(lines, 1) end
    log.Text = table.concat(lines, "\n")
end

-- Buttons
local hookBtn = Instance.new("TextButton")
hookBtn.Size = UDim2.new(0, 105, 0, 26)
hookBtn.Position = UDim2.new(0, 10, 0, 253)
hookBtn.BackgroundColor3 = Color3.fromRGB(200, 100, 50)
hookBtn.Text = "Hook Remote"
hookBtn.TextSize = 10
hookBtn.Font = Enum.Font.Gotham
hookBtn.Parent = f

local testBtn = Instance.new("TextButton")
testBtn.Size = UDim2.new(0, 105, 0, 26)
testBtn.Position = UDim2.new(0, 125, 0, 253)
testBtn.BackgroundColor3 = Color3.fromRGB(200, 150, 50)
testBtn.Text = "Test Webhook"
testBtn.TextSize = 10
testBtn.Font = Enum.Font.Gotham
testBtn.Parent = f

local sendBtn = Instance.new("TextButton")
sendBtn.Size = UDim2.new(0, 105, 0, 26)
sendBtn.Position = UDim2.new(0, 245, 0, 253)
sendBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
sendBtn.Text = "Send Events"
sendBtn.TextSize = 10
sendBtn.Font = Enum.Font.Gotham
sendBtn.Parent = f

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 105, 0, 26)
closeBtn.Position = UDim2.new(0, 127, 0, 285)
closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeBtn.Text = "Close"
closeBtn.TextSize = 10
closeBtn.Font = Enum.Font.GothamBold
closeBtn.Parent = f

-- Function to extract data from tables bypassing metatables
local function extractTableData(tbl, depth)
    depth = depth or 0
    if depth > 3 then return "[deep]" end
    if type(tbl) ~= "table" then return tostring(tbl) end
    
    local result = {}
    
    -- Try getrawmetatable to bypass __index
    local success, mt = pcall(getrawmetatable, tbl)
    if success and mt then
        pcall(setreadonly, mt, false)
    end
    
    -- Try numeric indices first
    for i = 1, 20 do
        local val = rawget(tbl, i)
        if val ~= nil then
            if type(val) == "table" then
                result[i] = extractTableData(val, depth + 1)
            else
                result[i] = tostring(val)
            end
        else
            break
        end
    end
    
    -- Try string keys
    for k, v in pairs(tbl) do
        if type(k) == "string" then
            if type(v) == "table" then
                result[k] = extractTableData(v, depth + 1)
            else
                result[k] = tostring(v)
            end
        end
    end
    
    return result
end

-- Hook the remote
local remote = nil
local original = nil
local hooked = false

local function findAndHookRemote()
    if hooked then
        addLog("Already hooked!")
        return true
    end
    
    addLog("Finding remote...")
    local success, r = pcall(function()
        return RS.Shared.Framework.Network.Remote.RemoteEvent
    end)
    
    if not success or not r then
        addLog("‚ùå Remote not found!")
        addLog("Searching for any RemoteEvent...")
        
        -- Try to find ANY remote event
        for _, obj in pairs(RS:GetDescendants()) do
            if obj:IsA("RemoteEvent") then
                addLog("Found: " .. obj:GetFullName())
            end
        end
        return false
    end
    
    remote = r
    addLog("‚úì Found: " .. remote.Name)
    
    return hookRemote()
end

local function hookRemote()
    if not remote then
        addLog("‚ùå No remote to hook!")
        return false
    end
    
    addLog("Connecting OnClientEvent...")
    local hookSuccess, hookErr = pcall(function()
        remote.OnClientEvent:Connect(function(...)
            local args = {...}
            eventCount = eventCount + 1
            
            -- IMMEDIATE visual feedback
            status.Text = "Events: " .. eventCount .. " | JUST FIRED!"
            status.TextColor3 = Color3.fromRGB(255, 100, 100)
            
            -- Build event string
            local eventStr = "==Event#" .. eventCount .. "==\n"
            eventStr = eventStr .. "Time: " .. os.date("%X") .. "\n"
            eventStr = eventStr .. "Args: " .. #args .. "\n"
            
            -- Process each argument
            for i, arg in ipairs(args) do
                local argType = type(arg)
                
                if argType == "string" then
                    eventStr = eventStr .. "EventName: " .. arg .. "\n"
                    addLog("Event: " .. arg)
                elseif argType == "number" then
                    eventStr = eventStr .. "Number: " .. tostring(arg) .. "\n"
                    addLog("Number: " .. arg)
                elseif argType == "table" then
                    -- Show basic table info
                    local keyCount = 0
                    local keys = {}
                    for k in pairs(arg) do
                        keyCount = keyCount + 1
                        table.insert(keys, tostring(k))
                    end
                    eventStr = eventStr .. "Table keys (" .. keyCount .. "): " .. table.concat(keys, ", ") .. "\n"
                    
                    -- Try direct property access
                    local eggName = arg.Name
                    local pets = arg.Pets
                    local speed = arg.Speed
                    
                    if eggName then
                        eventStr = eventStr .. "Egg: " .. tostring(eggName) .. "\n"
                        addLog("Egg: " .. eggName)
                    end
                    
                    if speed then
                        eventStr = eventStr .. "Speed: " .. tostring(speed) .. "\n"
                    end
                    
                    -- Access Pets array - try multiple methods
                    if pets then
                        local petsType = type(pets)
                        eventStr = eventStr .. "Pets type: " .. petsType .. "\n"
                        
                        if petsType == "table" then
                            -- Count pets
                            local petCount = 0
                            for _ in pairs(pets) do
                                petCount = petCount + 1
                            end
                            eventStr = eventStr .. "Pets count: " .. petCount .. "\n"
                            
                            -- Try numeric indices
                            for petIndex = 1, 20 do
                                local petData = pets[petIndex]
                                if petData and type(petData) == "table" then
                                    local pet = petData.Pet
                                    if pet and type(pet) == "table" then
                                        local petName = pet.Name
                                        if petName then
                                            eventStr = eventStr .. "  Pet" .. petIndex .. ": " .. tostring(petName)
                                            addLog("  Pet: " .. petName)
                                            if pet.Shiny then eventStr = eventStr .. " ‚ú®" end
                                            if pet.Mythic then eventStr = eventStr .. " üíé" end
                                            eventStr = eventStr .. "\n"
                                        end
                                    end
                                else
                                    break
                                end
                            end
                        else
                            eventStr = eventStr .. "Pets: " .. tostring(pets) .. "\n"
                        end
                    end
                end
            end
            
            eventStr = eventStr .. "\n"
            
            -- Store in StringValue
            storedEvents = storedEvents .. eventStr
            storage.Value = storedEvents
            
            -- Update status
            task.spawn(function()
                task.wait(0.2)
                status.Text = "Events: " .. eventCount .. " | Chars: " .. #storedEvents
                status.TextColor3 = Color3.fromRGB(100, 255, 100)
            end)
        end)
        
        hooked = true
        addLog("‚úì CONNECTED OnClientEvent!")
        hookBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
        hookBtn.Text = "‚úì Connected"
    end)
    
    if not hookSuccess then
        addLog("‚ùå Connection failed: " .. tostring(hookErr))
        return false
    end
    
    return true
end

hookBtn.Activated:Connect(function()
    findAndHookRemote()
end)

-- Test webhook
testBtn.Activated:Connect(function()
    if not httpLib then
        addLog("‚ùå No HTTP library!")
        return
    end
    
    addLog("Sending test...")
    local payload = {content = "üß™ Test from v5.0 - " .. os.date("%X")}
    local json = jsonEncode(payload)
    local headers = {["Content-Type"] = "application/json"}
    
    local success, _, status = httpLib(WEBHOOK, "POST", headers, json)
    
    if success and (status == 200 or status == 204) then
        addLog("‚úì Test sent!")
    else
        addLog("‚ùå Test failed: " .. tostring(status))
    end
end)

-- Send stored events
sendBtn.Activated:Connect(function()
    if not httpLib then
        addLog("‚ùå No HTTP!")
        return
    end
    
    if storedEvents == "" or #storedEvents < 10 then
        addLog("‚ùå No events stored!")
        addLog("Event count: " .. eventCount)
        addLog("Storage length: " .. #storedEvents)
        return
    end
    
    addLog("Sending " .. eventCount .. " events...")
    
    local content = "**Events: " .. eventCount .. "**\n```\n" .. storedEvents .. "\n```"
    if #content > 1900 then
        content = string.sub(content, 1, 1900) .. "...\n```"
    end
    
    local payload = {content = content}
    local json = jsonEncode(payload)
    local headers = {["Content-Type"] = "application/json"}
    
    local success, _, st = httpLib(WEBHOOK, "POST", headers, json)
    
    if success and (st == 200 or st == 204) then
        addLog("‚úì Sent " .. eventCount .. " events!")
        storedEvents = ""
        storage.Value = ""
        eventCount = 0
        status.Text = "Events: 0 | Stored: 0"
    else
        addLog("‚ùå Send failed: " .. tostring(st))
    end
end)

-- Close
closeBtn.Activated:Connect(function()
    addLog("Closing...")
    -- Send pending events first
    if #storedEvents > 10 then
        addLog("Sending final batch...")
        local content = "**Final Batch**\n```\n" .. storedEvents .. "\n```"
        if #content > 1900 then
            content = string.sub(content, 1, 1900) .. "...\n```"
        end
        local payload = {content = content}
        local json = jsonEncode(payload)
        httpLib(WEBHOOK, "POST", {["Content-Type"] = "application/json"}, json)
        task.wait(1)
    end
    g:Destroy()
    if storage then storage:Destroy() end
    error("Closed")
end)

addLog("Ready! Click 'Hook Remote'")
addLog("Then hatch eggs to test")

-- Auto-hook after 2 seconds
task.wait(2)
addLog("Auto-hooking in 1 second...")
task.wait(1)
findAndHookRemote()

-- Keep trying to hook if not successful
spawn(function()
    while not hooked do
        task.wait(3)
        if not hooked then
            findAndHookRemote()
        end
    end
end)

