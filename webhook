-- Test file for remote event hooking in Delta Executor Mobile
-- This will help us debug why events aren't being captured

local P = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local p = P.LocalPlayer
local newcclosure = newcclosure or function(func) return func end

wait(1)

-- Create a simple GUI for testing
local g = Instance.new("ScreenGui")
g.Name = "RemoteHookTest"
g.Parent = p.PlayerGui

local f = Instance.new("Frame")
f.Size = UDim2.new(0, 400, 0, 400)
f.Position = UDim2.new(0.5, -200, 0.5, -200)
f.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
f.BorderSizePixel = 0
f.Parent = g

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 40)
title.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
title.Text = "Remote Event Hook Test"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 18
title.Font = Enum.Font.GothamBold
title.Parent = f

local logDisplay = Instance.new("TextLabel")
logDisplay.Size = UDim2.new(0, 380, 0, 320)
logDisplay.Position = UDim2.new(0.5, -190, 0, 50)
logDisplay.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
logDisplay.BorderSizePixel = 0
logDisplay.Text = "Click 'Find Remote' to start..."
logDisplay.TextColor3 = Color3.fromRGB(150, 200, 255)
logDisplay.TextSize = 10
logDisplay.Font = Enum.Font.Gotham
logDisplay.TextWrapped = true
logDisplay.TextXAlignment = Enum.TextXAlignment.Left
logDisplay.TextYAlignment = Enum.TextYAlignment.Top
logDisplay.Parent = f

local function addLog(text)
    local current = logDisplay.Text or ""
    local lines = {}
    for line in string.gmatch(current, "([^\n]+)") do
        table.insert(lines, line)
    end
    table.insert(lines, text)
    while #lines > 20 do
        table.remove(lines, 1)
    end
    logDisplay.Text = table.concat(lines, "\n")
end

local remoteEvent = nil
local originalFireClient = nil
local hookCount = 0

local function findRemote()
    addLog("=== Finding Remote Event ===")
    
    local success, remote = pcall(function()
        return RS:FindFirstChild("Shared") 
            and RS.Shared:FindFirstChild("Framework") 
            and RS.Shared.Framework:FindFirstChild("Network") 
            and RS.Shared.Framework.Network:FindFirstChild("Remote") 
            and RS.Shared.Framework.Network.Remote:FindFirstChild("RemoteEvent")
    end)
    
    if success and remote then
        remoteEvent = remote
        addLog("✓ Found RemoteEvent!")
        addLog("Path: " .. remote:GetFullName())
        addLog("Class: " .. remote.ClassName)
        
        -- Check if it has FireClient method
        if remote.FireClient then
            addLog("✓ FireClient method exists")
            addLog("FireClient type: " .. type(remote.FireClient))
        else
            addLog("✗ FireClient method NOT found")
        end
        
        -- Check if it has OnClientEvent
        if remote.OnClientEvent then
            addLog("✓ OnClientEvent exists")
        else
            addLog("✗ OnClientEvent NOT found")
        end
        
        return true
    else
        addLog("✗ RemoteEvent NOT found")
        addLog("Checking ReplicatedStorage structure...")
        
        -- Try to find any RemoteEvent
        local allRemotes = {}
        for _, obj in pairs(RS:GetDescendants()) do
            if obj:IsA("RemoteEvent") then
                table.insert(allRemotes, obj:GetFullName())
            end
        end
        
        if #allRemotes > 0 then
            addLog("Found " .. #allRemotes .. " RemoteEvent(s):")
            for i, path in ipairs(allRemotes) do
                addLog("  " .. i .. ". " .. path)
            end
        else
            addLog("No RemoteEvents found in ReplicatedStorage")
        end
        
        return false
    end
end

local function hookFireClient()
    if not remoteEvent then
        addLog("ERROR: RemoteEvent not found! Click 'Find Remote' first.")
        return false
    end
    
    if originalFireClient then
        addLog("Already hooked! Unhooking first...")
        remoteEvent.FireClient = originalFireClient
        originalFireClient = nil
    end
    
    addLog("\n=== Attempting to Hook FireClient ===")
    
    local success, err = pcall(function()
        originalFireClient = remoteEvent.FireClient
        addLog("✓ Saved original FireClient")
        addLog("Original type: " .. type(originalFireClient))
        
        remoteEvent.FireClient = newcclosure(function(self, ...)
            hookCount = hookCount + 1
            local args = {...}
            addLog("\n[HOOK #" .. hookCount .. "] FireClient called!")
            addLog("  Args count: " .. #args)
            
            for i, arg in ipairs(args) do
                local argType = type(arg)
                addLog("  Arg[" .. i .. "]: " .. argType)
                
                if argType == "string" then
                    addLog("    Value: " .. arg)
                elseif argType == "number" then
                    addLog("    Value: " .. tostring(arg))
                elseif argType == "table" then
                    -- Count array elements
                    local arrayCount = 0
                    for _ in ipairs(arg) do
                        arrayCount = arrayCount + 1
                    end
                    addLog("    Array elements: " .. arrayCount)
                    
                    -- Count all keys (including string keys)
                    local keyCount = 0
                    local keys = {}
                    for k, v in pairs(arg) do
                        keyCount = keyCount + 1
                        table.insert(keys, tostring(k))
                    end
                    addLog("    Total keys: " .. keyCount)
                    if keyCount > 0 and keyCount <= 10 then
                        addLog("    Keys: " .. table.concat(keys, ", "))
                    end
                    
                    -- Check for specific known keys
                    if arg.Pets then
                        addLog("    ✓ Has 'Pets' key!")
                        if type(arg.Pets) == "table" then
                            local petCount = 0
                            for _ in pairs(arg.Pets) do
                                petCount = petCount + 1
                            end
                            addLog("    Pets table size: " .. petCount)
                            local petIndex = 0
                            for k, petData in pairs(arg.Pets) do
                                petIndex = petIndex + 1
                                if petIndex <= 5 then
                                    addLog("      Pet[" .. tostring(k) .. "]:")
                                    if type(petData) == "table" then
                                        if petData.Pet then
                                            if petData.Pet.Name then
                                                addLog("        Name: " .. petData.Pet.Name)
                                            end
                                            if petData.Pet.Shiny ~= nil then
                                                addLog("        Shiny: " .. tostring(petData.Pet.Shiny))
                                            end
                                            if petData.Pet.Mythic ~= nil then
                                                addLog("        Mythic: " .. tostring(petData.Pet.Mythic))
                                            end
                                        end
                                        if petData.Deleted ~= nil then
                                            addLog("        Deleted: " .. tostring(petData.Deleted))
                                        end
                                        if petData.New ~= nil then
                                            addLog("        New: " .. tostring(petData.New))
                                        end
                                    end
                                end
                            end
                        end
                    end
                    
                    if arg.Name then
                        addLog("    ✓ Has 'Name' key: " .. tostring(arg.Name))
                    end
                    
                    if arg.Speed then
                        addLog("    ✓ Has 'Speed' key: " .. tostring(arg.Speed))
                    end
                    
                    -- Show first few key-value pairs for debugging
                    local shown = 0
                    for k, v in pairs(arg) do
                        if shown < 5 then
                            local vType = type(v)
                            local vStr = ""
                            if vType == "string" then
                                vStr = v
                            elseif vType == "number" or vType == "boolean" then
                                vStr = tostring(v)
                            elseif vType == "table" then
                                vStr = "[table]"
                            else
                                vStr = "[" .. vType .. "]"
                            end
                            if #vStr > 50 then
                                vStr = string.sub(vStr, 1, 50) .. "..."
                            end
                            addLog("    " .. tostring(k) .. " = " .. vStr)
                            shown = shown + 1
                        end
                    end
                elseif argType == "Instance" then
                    if arg:IsA("Player") then
                        addLog("    Player: " .. arg.Name)
                    else
                        addLog("    Instance: " .. arg.ClassName)
                    end
                end
            end
            
            -- Call original
            return originalFireClient(self, unpack(args))
        end)
        
        addLog("✓ Hook installed")
        return true
    end)
    
    if success then
        addLog("✓ Hook successful!")
        return true
    else
        addLog("✗ Hook failed: " .. tostring(err))
        return false
    end
end

local function testOnClientEvent()
    if not remoteEvent then
        addLog("ERROR: RemoteEvent not found!")
        return
    end
    
    addLog("\n=== Testing OnClientEvent ===")
    
    local success, err = pcall(function()
        remoteEvent.OnClientEvent:Connect(function(...)
            hookCount = hookCount + 1
            local args = {...}
            addLog("\n[OnClientEvent #" .. hookCount .. "] Event received!")
            addLog("  Args count: " .. #args)
            
            for i, arg in ipairs(args) do
                local argType = type(arg)
                addLog("  Arg[" .. i .. "]: " .. argType)
                if argType == "string" then
                    addLog("    Value: " .. arg)
                elseif argType == "number" then
                    addLog("    Value: " .. tostring(arg))
                elseif argType == "table" then
                    local keyCount = 0
                    for _ in pairs(arg) do
                        keyCount = keyCount + 1
                    end
                    addLog("    Table with " .. keyCount .. " keys")
                    local shown = 0
                    for k, v in pairs(arg) do
                        if shown < 3 then
                            addLog("      " .. tostring(k) .. " = " .. tostring(v))
                            shown = shown + 1
                        end
                    end
                end
            end
        end)
    end)
    
    if success then
        addLog("✓ OnClientEvent connected")
    else
        addLog("✗ OnClientEvent failed: " .. tostring(err))
    end
end

local findBtn = Instance.new("TextButton")
findBtn.Size = UDim2.new(0, 120, 0, 35)
findBtn.Position = UDim2.new(0.5, -130, 0, 380)
findBtn.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
findBtn.BorderSizePixel = 0
findBtn.Text = "Find Remote"
findBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
findBtn.TextSize = 12
findBtn.Font = Enum.Font.Gotham
findBtn.Parent = f

local hookBtn = Instance.new("TextButton")
hookBtn.Size = UDim2.new(0, 120, 0, 35)
hookBtn.Position = UDim2.new(0.5, 10, 0, 380)
hookBtn.BackgroundColor3 = Color3.fromRGB(200, 100, 50)
hookBtn.BorderSizePixel = 0
hookBtn.Text = "Hook FireClient"
hookBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
hookBtn.TextSize = 12
hookBtn.Font = Enum.Font.Gotham
hookBtn.Parent = f

local testBtn = Instance.new("TextButton")
testBtn.Size = UDim2.new(0, 120, 0, 35)
testBtn.Position = UDim2.new(0.5, -60, 0, 340)
testBtn.BackgroundColor3 = Color3.fromRGB(120, 80, 200)
testBtn.BorderSizePixel = 0
testBtn.Text = "Test OnClientEvent"
testBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
testBtn.TextSize = 12
testBtn.Font = Enum.Font.Gotham
testBtn.Parent = f

findBtn.Activated:Connect(function()
    findRemote()
end)

hookBtn.Activated:Connect(function()
    hookFireClient()
end)

testBtn.Activated:Connect(function()
    testOnClientEvent()
end)

-- Auto-find on load
task.wait(1)
findRemote()

